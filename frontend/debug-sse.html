<!DOCTYPE html>
<html>
<head>
    <title>SSE Debug</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .message { border: 1px solid #ccc; padding: 10px; margin: 10px 0; }
        .raw-data { background: #f5f5f5; padding: 5px; }
        .formatted-data { white-space: pre-wrap; border-left: 3px solid #4a6fa5; padding-left: 10px; }
    </style>
</head>
<body>
    <h1>SSE 数据格式调试</h1>
    <button onclick="startTest()">开始测试</button>
    <div id="output"></div>

    <script>
        function startTest() {
            const output = document.getElementById('output');
            output.innerHTML = '<p>正在连接...</p>';
            
            // 创建 EventSource 连接
            const eventSource = new EventSource('http://localhost:8081/api/ai/chat?message=请列出1到5的数字，每行一个数字');
            
            let messageCount = 0;
            
            eventSource.onmessage = function(event) {
                messageCount++;
                console.log('Received data:', event.data);
                console.log('Data type:', typeof event.data);
                console.log('Contains newlines:', event.data.includes('\n'));
                console.log('JSON stringified:', JSON.stringify(event.data));
                
                // 显示原始数据和字符编码
                const dataDisplay = document.createElement('div');
                dataDisplay.className = 'message';
                dataDisplay.innerHTML = `
                    <h3>消息 ${messageCount}</h3>
                    <p><strong>原始数据:</strong> <span class="raw-data">${JSON.stringify(event.data)}</span></p>
                    <p><strong>数据长度:</strong> ${event.data.length}</p>
                    <p><strong>包含换行符:</strong> ${event.data.includes('\n')}</p>
                    <p><strong>包含\\n转义:</strong> ${event.data.includes('\\n')}</p>
                    <p><strong>显示效果:</strong></p>
                    <div class="formatted-data">${event.data}</div>
                    <hr/>
                `;
                output.appendChild(dataDisplay);
            };
            
            eventSource.onerror = function(err) {
                console.error('EventSource failed:', err);
                output.innerHTML += '<p style="color: red;">连接错误</p>';
            };
        }
    </script>
</body>
</html>